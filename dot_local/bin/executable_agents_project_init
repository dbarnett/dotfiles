#!/usr/bin/env bash
# agents_project_init - Initialize AGENTS files for a project
# Usage: Run from project root. Safe to run multiple times (idempotent).
#
# Note: Helper functions (break_refresh_mode, verbose, warn) available for
# consolidation. Future work: use break_refresh_mode() instead of IS_REFRESH=false
# in validation sections (currently lines ~188, 193, 216, 226).

set -e

# Configuration
SEED_VERSION="2025-12-17"  # Match ~/AGENTS.global.md Last Updated
REFRESH_DAYS=1  # Daily refresh is cheap, script detects if updates needed
GLOBAL_AGENTS_FILE="$HOME/AGENTS.global.md"

# Colors for output (if terminal supports it)
if [ -t 1 ]; then
    BOLD='\033[1m'
    GREEN='\033[0;32m'
    YELLOW='\033[0;33m'
    BLUE='\033[0;34m'
    RED='\033[0;31m'
    RESET='\033[0m'
else
    BOLD='' GREEN='' YELLOW='' BLUE='' RED='' RESET=''
fi

# Helper functions
break_refresh_mode() {
    # Call this when something unexpected is found that needs full output
    IS_REFRESH=false
}

verbose() {
    # Only print if not in refresh mode
    if [ "$IS_REFRESH" = false ]; then
        printf "$@"
    fi
}

warn() {
    # Always print warnings
    printf "${YELLOW}‚ö†Ô∏è  $1${RESET}\n"
    shift
    while [ $# -gt 0 ]; do
        printf "   $1\n"
        shift
    done
}

# Helper: Calculate date N days in future
date_plus_days() {
    # Try GNU date first (Linux), then BSD date (macOS)
    # Suppress stderr only because we expect one to fail
    if result=$(date -d "+$1 days" '+%Y-%m-%d' 2>/dev/null); then
        printf "%s" "$result"
    elif result=$(date -v "+${1}d" '+%Y-%m-%d' 2>/dev/null); then
        printf "%s" "$result"
    else
        # Fallback: use today (better than failing)
        warn "Could not calculate future date, using today"
        date '+%Y-%m-%d'
    fi
}

# Get today and refresh dates
TODAY=$(date '+%Y-%m-%d')
REFRESH_BY=$(date_plus_days "$REFRESH_DAYS")

printf "${BOLD}üîß Initializing AGENTS files for project${RESET}\n\n"

# Check we're in a reasonable directory
if [ ! -d .git ] && [ ! -d .jj ]; then
    printf "${RED}‚ùå Error: Not in a git or jj repository root${RESET}\n"
    printf "   Run this script from your project root directory\n"
    exit 1
fi

# Check if ~/AGENTS.global.md has been updated recently
GLOBAL_UPDATED=""
if [ -f "$GLOBAL_AGENTS_FILE" ] && [ -f AGENTS.local.md ]; then
    if [ "$GLOBAL_AGENTS_FILE" -nt AGENTS.local.md ]; then
        # Get mtimes - try GNU stat, then BSD stat
        # Suppress stderr because we expect one to fail
        global_mtime=$(stat -c %Y "$GLOBAL_AGENTS_FILE" 2>/dev/null || stat -f %m "$GLOBAL_AGENTS_FILE" 2>/dev/null || echo "")
        local_mtime=$(stat -c %Y AGENTS.local.md 2>/dev/null || stat -f %m AGENTS.local.md 2>/dev/null || echo "")
        if [ -n "$global_mtime" ] && [ -n "$local_mtime" ] && [ "$global_mtime" -gt 0 ] && [ "$local_mtime" -gt 0 ]; then
            days_diff=$(( (global_mtime - local_mtime) / 86400 ))
            GLOBAL_UPDATED="yes (${days_diff}d ago)"
        fi
    fi
fi

# Detect if this is a refresh (all files already exist) or first-time setup
IS_REFRESH=false
if [ -f AGENTS.local.md ] && [ -e AGENTS.md ] && [ -L CLAUDE.md ]; then
    IS_REFRESH=true
fi

# === 1. Create/update AGENTS.local.md ===
if [ "$IS_REFRESH" = false ]; then
    printf "${BLUE}üìù Setting up AGENTS.local.md...${RESET}\n"
fi

if [ -f AGENTS.local.md ]; then
    if [ "$IS_REFRESH" = false ]; then
        printf "   Already exists\n"
    fi
    if [ -n "$GLOBAL_UPDATED" ] && [ "$IS_REFRESH" = false ]; then
        printf "   ${YELLOW}‚ö†Ô∏è  ~/AGENTS.global.md updated $GLOBAL_UPDATED - consider refreshing${RESET}\n"
    fi
    LOCAL_EXISTS=true
else
    cat > AGENTS.local.md <<EOF
# Project-Specific Agent Instructions (Local)

**Last Updated:** $TODAY
**Refresh By:** $REFRESH_BY  (run agents_project_init daily, update this date when refreshing)
**Seed Version:** $SEED_VERSION  (template version from ~/AGENTS.global.md "Last Updated")

**Note:** See bottom of file for usage guidelines (what belongs here, file length conventions)

---

## üìã Current Task Context

**Active Focus:** [Brief note - reference bookmark/change ID, THIS_BRANCH.md, inline TODOs, docs/, issues]

**Recent Changes:**
- [$TODAY] [What you did - keep brief, link to commits/issues/docs where appropriate]

---

## üìå GitHub Issues

**‚ö†Ô∏è TODO: AGENTS MUST ASK USER - Should we track GitHub issues for this project?**

**If YES:**
- See \`~/.agents/agents-files-howto.md\` section "GitHub Issue Tracking" for commands
- Structure with inline expiry: "Next refresh: YYYY-MM-DD (update weekly, +7d from fetch)"
- File length convention: Keep under ~20 issues, extract to .agents/issues/ if growing

**If NO:**
- Replace this TODO with explanation (e.g., "Not tracked - using Jira" or "Not maintained")

---

## üìö Codebase Knowledge

<!-- Architecture notes, patterns, gotchas discovered during work -->
<!-- Prefer updating existing notes over creating new files -->

---

## üìñ Usage Guidelines

**What belongs in this file:**
- Machine-specific setup (paths, environment on THIS machine)
- Personal session context (what you're working on right now)
- Cached data that changes frequently (GitHub issues, recent changes)
- Project-specific architecture/patterns knowledge

**What does NOT belong here:**
- Info all team members should see ‚Üí Put in docs/ or committed AGENTS.md
- Tool usage patterns/configs ‚Üí Put in ~/AGENTS.TOOLS.local.md

**File management:**
- Keep this file scannable (< 200 lines recommended)
- ${BOLD}Prefer updating existing notes over creating new files${RESET}
- When growing: Extract detailed content to .agents/TOPIC.md, leave brief summary + link here
- Example: "See .agents/database-schema.md for DB architecture"

---

**End of AGENTS.local.md**
EOF
    printf "   ${GREEN}‚úÖ Created AGENTS.local.md${RESET}\n"
    LOCAL_EXISTS=false
fi

# === 2. Create CLAUDE.md symlink ===
if [ "$IS_REFRESH" = false ]; then
    printf "${BLUE}üîó Setting up CLAUDE.md symlink...${RESET}\n"
fi

if [ -L CLAUDE.md ]; then
    existing_target=$(readlink CLAUDE.md)
    if [ "$existing_target" = "AGENTS.md" ]; then
        [ "$IS_REFRESH" = false ] && printf "   Already points to AGENTS.md\n"
    else
        printf "   ${YELLOW}‚ö†Ô∏è  Points to: $existing_target (expected: AGENTS.md)${RESET}\n"
        IS_REFRESH=false  # Show full output if something is wrong
    fi
elif [ -f CLAUDE.md ]; then
    printf "   ${RED}‚ùå CLAUDE.md exists but is not a symlink${RESET}\n"
    printf "   Manual action needed: Check if it should be removed or renamed\n"
    IS_REFRESH=false
else
    ln -s AGENTS.md CLAUDE.md
    printf "   ${GREEN}‚úÖ Created CLAUDE.md ‚Üí AGENTS.md${RESET}\n"
fi

# === 3. Handle AGENTS.md ===
if [ "$IS_REFRESH" = false ]; then
    printf "${BLUE}üìÑ Checking AGENTS.md...${RESET}\n"
fi

AGENTS_ACTION=""

if [ -L AGENTS.md ]; then
    existing_target=$(readlink AGENTS.md)
    if [ "$IS_REFRESH" = false ]; then
        printf "   Exists as symlink ‚Üí $existing_target\n"
    fi
    if [ "$existing_target" = "AGENTS.local.md" ]; then
        AGENTS_ACTION="verify_symlink"
    else
        printf "   ${YELLOW}‚ö†Ô∏è  Points to unexpected target (expected: AGENTS.local.md)${RESET}\n"
        AGENTS_ACTION="verify_symlink"
        IS_REFRESH=false
    fi
elif [ -f AGENTS.md ]; then
    if [ "$IS_REFRESH" = false ]; then
        printf "   Exists as regular file (shared pattern)\n"
    fi
    # Check if it references AGENTS.local.md
    if ! grep -q "AGENTS\.local\.md" AGENTS.md 2>/dev/null; then
        printf "   ${YELLOW}‚ö†Ô∏è  AGENTS.md doesn't reference AGENTS.local.md - prelude missing${RESET}\n"
        AGENTS_ACTION="update_prelude"
        IS_REFRESH=false  # Show full output with warning
    else
        AGENTS_ACTION="verify_shared"
    fi
else
    ln -s AGENTS.local.md AGENTS.md
    printf "   ${GREEN}‚úÖ Created AGENTS.md ‚Üí AGENTS.local.md${RESET}\n"
    AGENTS_ACTION="default_setup"
fi

# === 4. Update .git/info/exclude ===
if [ "$IS_REFRESH" = false ]; then
    printf "${BLUE}üôà Updating .git/info/exclude...${RESET}\n"
fi

if [ -f .git/info/exclude ]; then
    EXCLUDE_FILE=".git/info/exclude"
elif [ -f .jj/repo/store/git/.git/info/exclude ]; then
    EXCLUDE_FILE=".jj/repo/store/git/.git/info/exclude"
else
    printf "   ${YELLOW}‚ö†Ô∏è  Could not find exclude file, skipping${RESET}\n"
    EXCLUDE_FILE=""
fi

if [ -n "$EXCLUDE_FILE" ]; then
    # Only add if not already present
    added_any=false

    # Add header comment if this is first time adding AGENTS files
    if ! grep -q '^# AGENTS files' "$EXCLUDE_FILE" 2>/dev/null; then
        cat >> "$EXCLUDE_FILE" <<'EOF'

# AGENTS files (added by agents_project_init)
# To convert to shared pattern: remove AGENTS.md and optionally CLAUDE.md from this list
AGENTS.local.md
EOF
        added_any=true
    elif ! grep -q '^AGENTS\.local\.md$' "$EXCLUDE_FILE" 2>/dev/null; then
        printf "AGENTS.local.md\n" >> "$EXCLUDE_FILE"
        added_any=true
    fi

    # Always ignore CLAUDE.md (it's just a symlink for compatibility)
    if ! grep -q '^CLAUDE\.md$' "$EXCLUDE_FILE" 2>/dev/null; then
        printf "CLAUDE.md\n" >> "$EXCLUDE_FILE"
        added_any=true
    fi

    # Ignore AGENTS.md if it's a symlink to AGENTS.local.md (default pattern)
    # If it's a real file (shared pattern), don't ignore it
    if [ -L AGENTS.md ]; then
        if ! grep -q '^AGENTS\.md$' "$EXCLUDE_FILE" 2>/dev/null; then
            printf "AGENTS.md\n" >> "$EXCLUDE_FILE"
            added_any=true
        fi
    fi

    if [ "$added_any" = true ]; then
        [ "$IS_REFRESH" = false ] && printf "   ${GREEN}‚úÖ Updated $EXCLUDE_FILE${RESET}\n"
    else
        [ "$IS_REFRESH" = false ] && printf "   All entries already present\n"
    fi
fi

# === Final summary and next steps ===

if [ "$IS_REFRESH" = true ]; then
    # Concise refresh output
    printf "\n${GREEN}‚úÖ Verified AGENTS files exist (AGENTS.md, AGENTS.local.md, CLAUDE.md) with appropriate git excludes.${RESET}\n\n"

    if [ -n "$GLOBAL_UPDATED" ]; then
        printf "${YELLOW}‚ö†Ô∏è  ~/AGENTS.global.md was updated $GLOBAL_UPDATED${RESET}\n"
        printf "   Consider reviewing for new conventions or template changes.\n\n"
    fi

    if [ ! -f THIS_BRANCH.md ]; then
        printf "${BOLD}ü§ñ AGENTS: Check if you should create THIS_BRANCH.md for current work${RESET}\n"
        printf "   If working on a task/change (not just exploring):\n"
        printf "   ${BLUE}Ask user:${RESET} \"Should we create THIS_BRANCH.md to track this work?\"\n"
        printf "   ${BLUE}If yes:${RESET} Run agents_task_init to bootstrap it\n\n"
    fi

    printf "${GREEN}Done!${RESET} ${BLUE}(Script is idempotent - run as frequently as needed)${RESET}\n"
    exit 0  # Exit early for refresh, don't show verbose output below
else
    # Full first-time setup output
    printf "\n${BOLD}${GREEN}‚úÖ Setup complete!${RESET}\n\n"

    printf "${BOLD}üìÅ Files created/verified:${RESET}\n"
    for f in AGENTS.md CLAUDE.md AGENTS.local.md; do
        if [ -e "$f" ] || [ -L "$f" ]; then
            ls -lh "$f" | awk '{print "   " $0}'
        else
            printf "   ${YELLOW}[missing] $f${RESET}\n"
        fi
    done

    printf "\n"
fi

# Only show "Next Steps" header if there are actual next steps
if [ "$AGENTS_ACTION" = "default_setup" ] || [ "$AGENTS_ACTION" = "update_prelude" ]; then
    printf "${BOLD}üö® Next Steps:${RESET}\n\n"
fi

case "$AGENTS_ACTION" in
    default_setup)
        printf "${BOLD}ü§ñ AGENTS: You MUST ask the user:${RESET}
   ${YELLOW}\"Should the AGENTS.md symlink be converted to a shared/committed AGENTS.md file?\"${RESET}

   ${BOLD}If user says NO:${RESET}
      ‚Üí Current setup is correct (private pattern)
      ‚Üí All content stays in AGENTS.local.md (gitignored)

   ${BOLD}If user says YES:${RESET}
      1. rm AGENTS.md  # Remove symlink
      2. Create real AGENTS.md file with repo-specific instructions
         - Include project setup, architecture notes, conventions, etc.
         - ${BOLD}MUST include prelude:${RESET} \"CRITICAL: You MUST read AGENTS.local.md if it exists\"
      3. Edit .git/info/exclude: Remove AGENTS.md line (see comment in file)
      4. Commit AGENTS.md to repo
      ‚Üí Result: AGENTS.md (committed) + AGENTS.local.md (gitignored, both real files)

   ${BOLD}Maintenance:${RESET} Expiry dates embedded in AGENTS.local.md sections

"
        ;;
    update_prelude)
        printf "${YELLOW}‚ö†Ô∏è  AGENTS.md missing required prelude${RESET}

   ${BOLD}ACTION REQUIRED:${RESET} Add this prelude to AGENTS.md (near top, after title):

   ${BLUE}---${RESET}
   ${BOLD}**CRITICAL: You MUST read AGENTS.local.md if it exists in this repository.**${RESET}
   ${BLUE}---${RESET}

"
        ;;
    verify_shared)
        # AGENTS.md is a real file with proper prelude - all good
        ;;
    verify_symlink)
        printf "   AGENTS.md symlink exists - verify it points to correct location\n\n"
        ;;
esac

if [ -n "$GLOBAL_UPDATED" ] && [ "$AGENTS_ACTION" != "default_setup" ]; then
    printf "\n${BOLD}${YELLOW}‚ö†Ô∏è  ~/AGENTS.global.md was recently updated${RESET}

   Your AGENTS.local.md seed template may be stale.
   Check ~/AGENTS.global.md for new conventions and update Seed Version ‚Üí $SEED_VERSION

"
fi

printf "\n${GREEN}Done!${RESET} ${BLUE}(Script is idempotent - run as frequently as needed)${RESET}\n"
