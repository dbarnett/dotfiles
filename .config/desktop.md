# Desktop Environment Configuration

**Last updated:** 2025-11-27

## Overview

Desktop setup using Hyprland via the HyDE (Hyprland Desktop Environment) framework on Arch Linux.

## Core Components

- **Compositor:** Hyprland 0.52.1
- **Desktop Framework:** HyDE
- **Status Bar:** Waybar (managed by HyDE's Python watcher)
- **Notification Daemon:** swaync (NOT dunst - see issues below)
- **Launcher:** vicinae, rofi
- **Terminal:** Kitty
- **Wallpaper:** swww with HyDE's wallbash color extraction

## HyDE Configuration System

HyDE dynamically generates waybar configs. Key locations:

- **System modules (READ-ONLY):** `~/.local/share/waybar/` - **NEVER EDIT** (overwritten on HyDE updates)
- **User customizations:** `~/.config/waybar/` - **EDIT HERE**
  - `modules/` - Custom module configurations (`.jsonc` files)
  - `styles/` - Custom CSS styles
  - `layouts/` - Layout configurations
  - `includes/` - Auto-generated by `waybar.py` (don't edit)
- **Waybar watcher:** `~/.local/lib/hyde/waybar.py --watch` (runs as background process)

**Proper workflow:**
1. Copy module from `~/.local/share/waybar/modules/` to `~/.config/waybar/modules/`
2. Edit the copy in `~/.config/waybar/modules/`
3. Files in `~/.config/waybar/` override system defaults and are tracked in git

**Reference:** [HyDE Waybar Documentation](https://hydeproject.pages.dev/de/configuring/waybar/)

## Customizations Applied

### Waybar Module Overrides

Custom modules in `~/.config/waybar/modules/` (copied from HyDE defaults and modified):

1. **`battery.jsonc`** - Battery with visual states
   - Shows icon that changes with charge level and percentage
   - Format: `{icon} {capacity}%`
   - Icons change from empty to full battery (11 states)
   - **NOTE:** Color states currently commented out (would enable green >80%, yellow <30%, red <15%)

2. **`idle_inhibitor.jsonc`** - Caffeine mode indicator
   - Shows icon-only display (ó°¾ª active / ó¿ªª inactive)
   - Click to toggle preventing screen sleep
   - Tooltip shows colored status text with full explanation

3. **`pulseaudio#microphone.jsonc`** - Mic indicator
   - Shows only icon ( unmuted /  muted)
   - Click to open pavucontrol, middle-click to toggle mute
   - Tooltip shows source device and volume percentage

4. **`custom-keyboard.jsonc`** - Keyboard layout indicator
   - Script: `~/.local/bin/waybar-keyboard-layout`
   - Shows flags: ðŸ‡ºðŸ‡¸ (English) / ðŸ‡²ðŸ‡½ (Spanish)
   - Click to switch layouts via hyde-shell
   - **NOTE:** Currently NOT in HyDE's generated config, needs manual addition

5. **`hyprland-language.jsonc`** - Alternative keyboard layout module
   - Uses built-in Hyprland language module (simpler than custom/keyboard)

### Scripts Created

- **`~/.local/bin/waybar-keyboard-layout`** - Converts Hyprland keyboard layout to flag emoji

## Known Issues & Fixes

### Issue: Dunst vs Swaync Conflict

**Problem:** Dunst auto-starts via DBus activation, preventing swaync from running.

**Solution Applied:**
```bash
# Masked systemd service
systemctl --user mask dunst.service

# Masked DBus activation
ln -sf /dev/null ~/.local/share/dbus-1/services/org.knopwob.dunst.service
```

**Verify swaync is running:**
```bash
ps aux | grep "[s]waync"
busctl --user list | grep Notifications
```

### Issue: Hyprland Window Rule Errors

**Problem:** Added invalid `urgent` parameter to windowrulev2 (doesn't exist in Hyprland).

**Solution:** Removed the broken rule. Web notification click-to-focus is a known Wayland limitation.

### Issue: Config Auto-Regeneration

**Problem:** HyDE regenerates `~/.config/waybar/config.jsonc` and `~/.config/waybar/includes/includes.jsonc` dynamically.

**Solution:** Don't edit auto-generated files. Place custom modules in `~/.config/waybar/modules/` instead.

### Issue: Module Overrides Not Working

**Problem:** Custom modules in `~/.config/waybar/modules/` get overridden by system modules.

**Root cause:** HyDE's `waybar.py` generates `includes/includes.json` that includes BOTH `~/.config/waybar/modules/` AND `~/.local/share/waybar/modules/`. When the same module exists in both locations, waybar loads the LAST one listed (system file), overriding the user customization.

**Workaround:** Delete or rename conflicting files in `~/.local/share/waybar/modules/` after creating custom versions.

**Permanent fix needed:** This appears to be a HyDE bug - the watcher should exclude system files that have user overrides.

## Next Steps / TODO

- [ ] Add `custom/keyboard` to HyDE's waybar layout config
- [ ] Configure swaync appearance (currently using default with large bell icon)
- [ ] Investigate HyDE config.ctl system for permanent waybar layout changes
- [ ] Fix notification click behavior (currently shows kitty terminal popup)
- [ ] Configure wallbash to use `--vibrant` profile for better color contrast
- [ ] Remove/configure hidden waybar modules (custom/wallchange, custom/theme, etc.)

## HyDE Color System (Wallbash)

Colors are extracted from wallpapers via `~/.local/lib/hyde/wallbash.sh`.

**Color profiles available:**
- `--default` - Balanced (current)
- `--vibrant` - Higher saturation, better contrast
- `--pastel` - Muted colors
- `--mono` - Monochrome

**To change profile:** Modify how wallbash is called in HyDE's wallpaper scripts.

## Useful Commands

```bash
# Restart waybar
systemctl --user restart hyde-hyprland-bar.service

# Check waybar logs
journalctl --user -u hyde-hyprland-bar.service -n 50

# Reload Hyprland config
hyprctl reload

# Check Hyprland config errors
hyprctl configerrors

# Check keyboard layout
hyprctl devices -j | jq -r '.keyboards[] | select(.main == true) | .active_keymap'

# Kill notification daemon and restart
killall swaync && swaync &
```

## Files Modified in Dotfiles

Tracked in git (in `~/.config/`):
- `hypr/windowrules.conf` - Hyprland window rules (removed broken urgent rule)

**âš ï¸ TO BE ADDED TO GIT:**
- `waybar/modules/battery.jsonc` - Battery module override
- `waybar/modules/idle_inhibitor.jsonc` - Caffeine mode indicator
- `waybar/modules/pulseaudio#microphone.jsonc` - Mic indicator
- `waybar/modules/custom-keyboard.jsonc` - Keyboard layout flags
- `waybar/modules/hyprland-language.jsonc` - Alternative keyboard layout

Not tracked (outside `~/.config/`):
- `~/.local/bin/waybar-keyboard-layout` - Custom keyboard layout script
- `~/.local/share/dbus-1/services/org.knopwob.dunst.service` - Dunst DBus mask

## References

- [Hyprland Wiki](https://wiki.hyprland.org/)
- [HyDE Project](https://github.com/prasanthrangan/HyDE)
- [Waybar Wiki](https://github.com/Alexays/Waybar/wiki)
- [SwayNC](https://github.com/ErikReider/SwayNotificationCenter)
